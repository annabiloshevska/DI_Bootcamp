CREATE TABLE employees (
  comp_code_emp       TEXT,
  employee_code_emp   INTEGER,
  employee_name_emp   TEXT,
  gender              TEXT,
  age                 INTEGER
);
-- Insert data (SQLite)
INSERT INTO employees (comp_code_emp, employee_code_emp, employee_name_emp, gender, age) VALUES
('1', 9875, 'Dawson Crawford', 'M', 25),
('ELMO', 206, 'Bryce Bennett', 'F', 28),
('83', 29417, 'Robert Lewis', 'M', 24),
('83', 18879, 'Terence Buck', 'M', 35),
('83', 18883, 'Kevin Walker', 'M', 35),
('83', 30696, 'Freddy Guerra', 'M', 26),
('83', 24864, 'Samuel Clark', 'M', 28),
('83', 24866, 'Jonathan Thompson', 'M', 23),
('ELMO', 26528, 'Chase Bailey', 'F', 33),
('83', 9371, 'Benjamin Gonzalez', 'M', 37),
('83', 16834, 'Dylan Lopez', 'M', 20),
('83', 24407, 'Bryant Pearson', 'M', 33),
('1', 27261, 'Brent Delgado', 'M', 23),
('1', 24213, 'Josiah Hunt', 'M', 38),
('1', 30681, 'Alonso Singleton', 'M', 25),
('83', 31823, 'Vaughn Lynn', 'M', 18),
('83', 33029, 'Kara Coleman', 'F', 21),
('ELMO', 26734, 'Mark Bell', 'M', 24),
('ELMO', 25379, 'Trevor Cooper', 'M', 31),
('83', 26193, 'Jacob Smith', 'M', 38),
('1', 8477, 'Luke Parker', 'M', 38),
('83', 31290, 'Hamza Lozano', 'M', 34),
('83', 25322, 'Michael Johnson', 'M', 30),
('83', 25648, 'Noah Harris', 'M', 34),
('83', 23007, 'Christopher Jones', 'M', 25),
('83', 18876, 'Joseph Garcia', 'M', 24),
('83', 23198, 'Andrew Davis', 'M', 18),
('83', 31961, 'Jalon Sanford', 'M', 22),
('83', 26830, 'Daniel Rodriguez', 'M', 22),
('83', 27127, 'Joshua Brown', 'M', 25),
('1', 28000, 'Elijah Mitchell', 'M', 23),
('1', 28537, 'Maximilian Hines', 'M', 23),
('1', 28507, 'Deven Farmer', 'M', 19),
('1', 30802, 'Anton Brennan', 'M', 23),
('1', 31887, 'Isaak Spence', 'M', 24),
('1', 29182, 'Rodolfo Acosta', 'M', 22),
('1', 27810, 'Steven Carter', 'M', 18),
('1', 31358, 'Mikel Arias', 'M', 21),
('1', 27040, 'Andres Henry', 'M', 23),
('1', 28129, 'Ahmad Adkins', 'M', 20),
('1', 25014, 'Mario Simpson', 'M', 19),
('2', 30157, 'Cesar Porter', 'M', 18),
('2', 30399, 'Dillon Jimenez', 'M', 24),
('2', 28165, 'Derick Davenport', 'M', 22),
('ELMO', 31038, 'Austen Sawyer', 'M', 21),
('83', 25634, 'Nicholas Miller', 'M', 32),
('1', 32162, 'Andrea Chaney', 'F', 30),
('1', 33116, 'Carmen Patel', 'F', 24),
('1', 30441, 'Nelson Cummings', 'M', 38),
('83', 30367, 'Alexander Jackson', 'M', 42),
('129', 31148, 'Tristian Ware', 'M', 36),
('129', 31956, 'Rey McPherson', 'M', 34),
('129', 32921, 'Savanna Chavez', 'F', 32),
('1', 28484, 'Aron Petersen', 'M', 27),
('1', 29631, 'Kane Bryan', 'M', 30),
('1', 29733, 'Scott Olson', 'M', 23),
('1', 32458, 'Audrey Scott', 'F', 18),
('1', 32238, 'Catherine Williams', 'F', 26),
('1', 32900, 'Tara Simpson', 'F', 37),
('1', 31267, 'Don Weeks', 'M', 27),
('1', 27747, 'Kristopher Chen', 'M', 34),
('ELMO', 30225, 'Spencer Price', 'M', 33),
('ELMO', 27042, 'Jesus Reed', 'M', 33),
('83', 29060, 'Justin Martin', 'M', 29),
('1', 9134, 'Mohamed Blake', 'M', 26),
('83', 18441, 'Austin White', 'F', 20),
('83', 32208, 'Olivia McGrath', 'F', 28),
('83', 13719, 'Nathan Robinson', 'M', 25),
('ELMO', 28231, 'Lucas Ward', 'M', 23),
('ELMO', 30785, 'Milton Horn', 'M', 23),
('ELMO', 28228, 'Jeremy Cox', 'M', 25),
('ELMO', 29834, 'Tanner Gray', 'M', 19),
('ELMO', 29884, 'Kenneth James', 'M', 21),
('ELMO', 29891, 'Stephen Reyes', 'M', 19),
('ELMO', 29895, 'Jake Cruz', 'F', 22),
('ELMO', 30170, 'Isaac Roberts', 'M', 21),
('ELMO', 31551, 'Maverick Villa', 'M', 23),
('ELMO', 32257, 'Mary Esparza', 'F', 19),
('ELMO', 32722, 'Valerie James', 'F', 21),
('ELMO', 31667, 'Michelle Haney', 'F', 21),
('ELMO', 31863, 'Jovany Villegas', 'M', 19),
('ELMO', 31864, 'Kale Proctor', 'M', 20),
('ELMO', 31866, 'Nicklaus Hester', 'M', 22),
('ELMO', 31868, 'Zander Cantrell', 'M', 19),
('ELMO', 25434, 'James Moore', 'M', 23),
('83', 32387, 'Briana Jones', 'F', 18),
('83', 32027, 'Augustus Hanna', 'M', 19),
('83', 31861, 'Dontae McCann', 'M', 22),
('83', 33099, 'Genesis Wagner', 'M', 24),
('83', 28235, 'Gordon Bradford', 'M', 21),
('83', 29838, 'Kyle Young', 'M', 20),
('83', 29836, 'Jose Hall', 'M', 19),
('83', 29837, 'Jason Sanchez', 'M', 19),
('83', 29886, 'Caleb Allen', 'M', 20),
('83', 28767, 'Thomas Perez', 'M', 21),
('129', 33010, 'Kylee Hamilton', 'F', 20),
('129', 32899, 'Esmeralda Jordan', 'F', 19),
('129', 32931, 'Amaya Reynolds', 'F', 22),
('129', 32160, 'Jennifer Duke', 'F', 22),
('129', 31611, 'Dewayne Peck', 'M', 23),
('129', 31718, 'Mariano Benton', 'M', 24),
('1', 23736, 'Eliseo Blanchard', 'M', 25),
('1', 28234, 'Kurt Decker', 'M', 22),
('1', 28630, 'Dalton Brooks', 'M', 20),
('1', 31136, 'Jamari Small', 'M', 23),
('1', 30040, 'Zion Walsh', 'M', 25),
('1', 28250, 'Russell Valdez', 'M', 23),
('1', 29720, 'Gilberto Gallagher', 'M', 18),
('1', 31461, 'Prince Harding', 'M', 21),
('1', 32261, 'Danielle Braun', 'F', 21),
('1', 31513, 'Bronson Pineda', 'M', 21),
('2', 32244, 'Gabrielle Gay', 'F', 18),
('1', 33222, 'Celeste Ryan', 'F', 22),
('1', 32155, 'Vanessa Cowan', 'F', 21),
('1', 33020, 'Patricia Alvarez', 'F', 23),
('1', 33073, 'Eva Hoffman', 'F', 18),
('1', 30395, 'Deon Greer', 'M', 19),
('1', 30695, 'Cordell Mathis', 'M', 21),
('1', 33013, 'Elena Freeman', 'F', 22),
('1', 29803, 'Grant Hamilton', 'M', 23),
('1', 30192, 'Gregory Chavez', 'M', 19),
('1', 31660, 'Paxton Ali', 'M', 23),
('1', 24941, 'Gage Snyder', 'M', 23),
('1', 30390, 'Lane Schultz', 'M', 32),
('1', 31789, 'Harvey Choi', 'M', 36),
('1', 28758, 'Sebastian Kelly', 'M', 22),
('1', 27024, 'Blake Gomez', 'M', 20),
('129', 30795, 'Cruz Abbott', 'M', 25),
('83', 27945, 'Cristopher Rivas', 'M', 33),
('83', 29765, 'Brandon Martinez', 'M', 21),
('83', 32504, 'Zoe Brown', 'F', 20),
('ELMO', 28729, 'Antonio Howard', 'M', 25),
('ELMO', 31901, 'Braiden Beltran', 'M', 18),
('1', 28775, 'Aidan Barnes', 'M', 31),
('1', 31406, 'Camren Mahoney', 'F', 29),
('1', 31540, 'Ryley Gould', 'F', 22),
('1', 32356, 'Caroline Davies', 'F', 31),
('1', 33063, 'Aliyah Tran', 'F', 28),
('1', 24358, 'Garret Barber', 'M', 37),
('83', 29648, 'Zachary Taylor', 'M', 21),
('83', 27602, 'Matthew Williams', 'M', 28),
('83', 31189, 'Antwan Russo', 'M', 30),
('83', 31359, 'Ryder Bartlett', 'M', 37),
('83', 12346, 'John Anderson', 'M', 19),
('83', 31103, 'Brooks Baxter', 'F', 22),
('83', 28590, 'William Wilson', 'M', 19),
('ELMO', 20523, 'Gavin Diaz', 'M', 25),
('ELMO', 20521, 'Miguel Richardson', 'M', 25),
('129', 30866, 'Ignacio Boone', 'M', 26),
('129', 32813, 'Kristen Rivera', 'F', 22),
('2', 30330, 'Pablo Walters', 'M', 32),
('1', 27497, 'Alfredo Little', 'M', 22),
('1', 32213, 'Sara Gamble', 'F', 20),
('1', 29958, 'Travis Fisher', 'M', 22),
('1', 29418, 'Bennett Yang', 'M', 22),
('2', 28445, 'Emmanuel Rose', 'M', 37),
('1', 31776, 'Kian Yu', 'M', 25),
('1', 31828, 'Isidro Estes', 'M', 31),
('1', 32493, 'Lily Mitchell', 'F', 34),
('1', 32781, 'Desiree Russell', 'F', 22),
('1', 28809, 'Jermaine Figueroa', 'M', 27),
('1', 33070, 'Rose Knight', 'F', 31),
('ELMO', 20091, 'Alejandro Watson', 'F', 32),
('ELMO', 23821, 'Marcus Myers', 'M', 32),
('83', 31160, 'Conrad Golden', 'M', 22),
('83', 26010, 'Brian Scott', 'M', 37),
('83', 26640, 'Adam Green', 'M', 21),
('83', 30983, 'Greyson Hutchinson', 'M', 24),
('83', 29415, 'Luis Hill', 'M', 38),
('ELMO', 27981, 'Victor Hughes', 'M', 25),
('ELMO', 31998, 'Brant Dickson', 'M', 30);

--Exercise 1: Building a Comprehensive Dataset for Employee Analysis
SELECT * FROM functions
--Create a temporary table that join all tables and create a new one using LEFT JOIN.
CREATE TEMPORARY TABLE emp_dataset AS
SELECT 
    e.employee_code_emp AS employee_id,
    e.employee_name_emp as employee_name,
    e.gender AS gender,
    e.age,
    s.date,
    s.salary,
    f.function_code,
    f.function_group,
    c.company_name,
    c.company_city,
    c.company_state,
    c.company_type,
    c.const_site_category
FROM employees e
LEFT JOIN salaries s ON e.employee_code_emp = s.employee_id
LEFT JOIN functions f ON s.func_code = f.function_code
LEFT JOIN companies c ON s.comp_name = c.company_name;
SELECT * FROM emp_dataset

--Create an unique identifier code between the columns ‘employee_id’ and ‘date’ and call it ‘id’.
--Convert the column ‘date’ to DATE type because it was previously configured as TIMESTAMP.
--Transform this new table into a dataset “df_employee” for analysis.
CREATE TABLE df_employee AS
SELECT 
    employee_id || '_' || SUBSTR(date, 7, 4) || '-' || SUBSTR(date, 4, 2) || '-' || SUBSTR(date, 1, 2) AS id,
    SUBSTR(date, 7, 4) || '-' || SUBSTR(date, 4, 2) || '-' || SUBSTR(date, 1, 2) AS month_year,
    employee_id, 
    employee_name, 
    gender,  
    age,
    salary,
    function_code,
    function_group, 
    company_name, 
    company_city, 
    company_state, 
    company_type, 
    const_site_category
FROM emp_dataset;

SELECT * FROM df_employee;
--2. Remove all unwanted spaces from all text columns using TRIM
UPDATE df_employee
SET
    id = TRIM(id),
    employee_id = TRIM(employee_id),
    employee_name = TRIM(employee_name),
    gender = TRIM(gender),
    function_code = TRIM(function_code),
    function_group = TRIM(function_group),
    company_name = TRIM(company_name),
    company_city = TRIM(company_city),
    company_state = TRIM(company_state),
    company_type = TRIM(company_type),
    const_site_category = TRIM(const_site_category);

--3. Check for NULL values and empty values.
SELECT *
FROM df_employee
WHERE id IS NULL
	OR month_year IS NULL
	OR employee_id IS NULL
	OR employee_name IS NULL
	OR gender IS NULL
	OR age IS NULL
	OR salary IS NULL
	OR function_code IS NULL
	OR function_group IS NULL
	OR company_name IS NULL
	OR company_city IS NULL
	OR company_state IS NULL
	OR company_type IS NULL
	OR const_site_category IS NULL;

--4. Delete rows of the detected missing values.
DELETE FROM df_employee
WHERE id IS NULL
    OR month_year IS NULL
    OR employee_id IS NULL
    OR employee_name IS NULL
    OR gender IS NULL
    OR age IS NULL
    OR salary IS NULL
    OR function_code IS NULL
    OR function_group IS NULL
    OR company_name IS NULL
    OR company_city IS NULL
    OR company_state IS NULL
    OR company_type IS NULL
    OR const_site_category IS NULL;

--Exercise 3 : Calculating Current Employee Counts by Company
--How many employees do the companies have today?
-- Group them by company
SELECT company_name,
	   COUNT(DISTINCT employee_id) AS employee_count 
FROM df_employee
WHERE month_year = (SELECT MAX(month_year) FROM df_employee)
GROUP BY company_name
ORDER BY employee_count DESC

--Exercise 4 : Analyzing Employee Distribution by City and Over Time
--What is the total number of employees each city? Add a percentage column
SELECT company_city, 
       COUNT(employee_id) AS employee_count,
       ROUND(COUNT(employee_id) * 100.0 / SUM(COUNT(employee_id)) OVER ()) AS percentage
FROM df_employee
WHERE month_year = (SELECT MAX(month_year) FROM df_employee)
GROUP BY company_city
ORDER BY employee_count DESC;

--What is the total number of employees each month?
SELECT month_year, 
	   COUNT(DISTINCT employee_id) AS employee_count 
FROM df_employee
GROUP BY month_year
ORDER BY month_year ASC;

--What is the average number of employees each month?
SELECT (COUNT(employee_id) / COUNT(DISTINCT month_year)) AS avg_employees_per_month
FROM df_employee;

--Exercise 5 : Analyzing Employment Trends and Salary Metrics
--What is the minimum and maximum number of employees throughout all the months? In which months were they?
-- Minimum
SELECT month_year, COUNT(employee_id) AS count_employees_per_month
FROM df_employee
GROUP BY month_year
ORDER BY count_employees_per_month ASC
LIMIT 1;

-- Maximum
SELECT  TOP (1) month_year, COUNT(employee_id) AS count_employees_per_month
FROM df_employee
GROUP BY month_year
ORDER BY count_employees_per_month DESC;

--What is the monthly average number of employees by function group?
SELECT function_group, (COUNT(employee_id) / COUNT(DISTINCT month_year)) AS avg_employees_per_month
FROM df_employee
GROUP BY function_group
ORDER BY avg_employees_per_month DESC;

--What is the annual average salary?

SELECT SUBSTR(month_year, 1, 4) AS year, ROUND(AVG(salary), 2) AS average_salary
FROM df_employee
GROUP BY SUBSTR(month_year, 1, 4)
ORDER BY year;
